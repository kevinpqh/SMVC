(function(){angular.module("loc8rApp",["ngRoute","ngSanitize","ui.bootstrap"]);function e(e,n){e.when("/",{templateUrl:"home/home.view.html",controller:"homeCtrl",controllerAs:"vm"}).when("/about",{templateUrl:"/common/views/genericText.view.html",controller:"aboutCtrl",controllerAs:"vm"}).when("/location/:locationid",{templateUrl:"/locationDetail/locationDetail.view.html",controller:"locationDetailCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"/auth/register/register.view.html",controller:"registerCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"/auth/login/login.view.html",controller:"loginCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/"});n.html5Mode(true)}angular.module("loc8rApp").config(["$routeProvider","$locationProvider",e])})();(function(){angular.module("loc8rApp").controller("homeCtrl",e);e.$inject=["$scope","loc8rData","geolocation","authentication"];function e(e,n,t,o){var r=this;r.pageHeader={title:"Loc8r",strapline:"Find places to work with wifi near you!"};r.sidebar={content:"Looking for wifi and a seat etc etc"};r.message="Checking your location";if(!o.isLoggedIn()){return}r.currentUser=o.currentUser();var i;var a={};var l={};onBistriConferenceReady=function(){if(!BistriConference.isCompatible()){alert("your browser is not WebRTC compatible !");return}BistriConference.signaling.addHandler("onConnected",function(){p("pane_1")});BistriConference.signaling.addHandler("onError",function(){alert(error.text+" ("+error.code+")")});BistriConference.signaling.addHandler("onJoinedRoom",function(e){i=e.room;p("pane_2");for(var n=0,t=e.members.length;n<t;n++){a[e.members[n].id]=e.members[n].name;BistriConference.openDataChannel(e.members[n].id,"chat",e.room)}});BistriConference.signaling.addHandler("onJoinRoomError",function(e){alert(e.text+" ("+e.code+")")});BistriConference.signaling.addHandler("onQuittedRoom",function(e){p("pane_1");BistriConference.stopStream()});BistriConference.signaling.addHandler("onPeerJoinedRoom",function(e){a[e.pid]=e.name});BistriConference.signaling.addHandler("onPeerQuittedRoom",function(e){delete a[e.pid]});BistriConference.channels.addHandler("onDataChannelCreated",c);BistriConference.channels.addHandler("onDataChannelRequested",c);u();v("#join").addEventListener("click",s);v("#quit").addEventListener("click",d);v("#send").addEventListener("click",f)};function c(e,n){e.onOpen=function(){l[n]=this;g()};e.onClose=function(){delete l[n];g()};e.onMessage=function(e){m(a[n],e.data)}}function u(){var e=r.currentUser.name;if(e){BistriConference.init({appId:"7a5eebc7",appKey:"4465c0d6fb1f64b3d870e90e93080b57",userName:e,debug:true});BistriConference.connect()}else{alert("you must enter a nickname !")}}function s(){var e=r.formData.numero;r.makeCall();if(e){BistriConference.joinRoom(e)}else{alert("you must enter a room name !")}}function d(){for(var e in l){l[e].close()}BistriConference.quitRoom(i)}function f(){var e=v("#message_field").value;if(e){for(var n in l){l[n].send(e)}m("me",e);v("#message_field").value=""}}function m(e,n){var t=v("#messages_container");var o=document.createTextNode(e+" > "+n);var r=document.createElement("div");r.className="message";r.appendChild(o);t.appendChild(r);t.scrollTop=t.scrollHeight}function g(){if(Object.keys(l).length){v("#send").removeAttribute("disabled")}else{v("#send").setAttribute("disabled","disabled")}}function p(e){var n=document.querySelectorAll(".pane");for(var t=0,o=n.length;t<o;t++){n[t].style.display=n[t].id==e?"block":"none"}}function v(e){return document.querySelector(e)}var h=document.getElementById("vid-box");var b=document.getElementById("video-display");var C=0;r.login=function(){var e=window.phone=PHONE({number:r.currentUser.username||"Anonymous",publish_key:"pub-c-561a7378-fa06-4c50-a331-5c0056d0163c",subscribe_key:"sub-c-17b7db8a-3915-11e4-9868-02ee2ddab7fe",ssl:true});var n=window.ctrl=CONTROLLER(e,y);n.ready(function(){n.addLocalStream(b)});n.receive(function(e){e.connected(function(e){h.appendChild(e.video)});e.ended(function(e){n.getVideoElement(e.number).remove()})});n.videoToggled(function(e,t){n.getVideoElement(e.number).toggle(t)});n.audioToggled(function(e,t){n.getVideoElement(e.number).css("opacity",t?1:.75)});return false};r.makeCall=function(){if(!window.phone)alert("Login First!");var e=r.formData.numero;if(phone.number()==e)return false;ctrl.isOnline(e,function(n){if(n)ctrl.dial(e);else alert("User if Offline")});return false};r.mute=function(){var e=ctrl.toggleAudio();if(!e)$("#mute").html("Unmute");else $("#mute").html("Mute")};r.end=function(){ctrl.hangup()};r.pause=function(){var e=ctrl.toggleVideo();if(!e)$("#pause").html("Unpause");else $("#pause").html("Pause")};function w(e){return $('*[data-number="'+e+'"]')}function A(e){$("#logs").append("<p>"+e+"</p>")}function y(){var e;$.ajax({type:"POST",url:"https://service.xirsys.com/ice",data:{room:"default",application:"default",domain:"kevingleason.me",ident:"gleasonk",secret:"b9066b5e-1f75-11e5-866a-c400956a1e19",secure:1},success:function(n){console.log(n);n=JSON.parse(n);if(!n.e)e=n.d.iceServers},async:false});return e}function E(e,n){try{return e(n)}catch(e){alert("WebRTC is currently only supported by Chrome, Opera, and Firefox");return false}}}})();(function(){angular.module("loc8rApp").controller("aboutCtrl",e);function e(){var e=this;e.pageHeader={title:"About Loc8r"};e.main={content:"Loc8r was created to help people find places to sit down and get a bit of work done.\n\nLorem ipsum dolor sit amet, consectetur adipiscing elit."}}})();(function(){angular.module("loc8rApp").controller("loginCtrl",e);e.$inject=["$location","authentication"];function e(e,n){var t=this;t.pageHeader={title:"Inicie Sesion"};t.credentials={email:"",password:""};t.returnPage=e.search().page||"/";t.onSubmit=function(){t.formError="";if(!t.credentials.email||!t.credentials.password){t.formError="Todos lo campos Son requeridos";return false}else{t.doLogin()}};t.doLogin=function(){t.formError="";n.login(t.credentials).error(function(e){t.formError=e}).then(function(){e.search("page",null);e.path(t.returnPage)})}}})();(function(){angular.module("loc8rApp").controller("registerCtrl",e);e.$inject=["$location","authentication"];function e(e,n){var t=this;t.pageHeader={title:"Cuenta Nueva"};t.credentials={name:"",email:"",password:"",username:""};t.returnPage=e.search().page||"/";t.onSubmit=function(){t.formError="";if(!t.credentials.name||!t.credentials.username||!t.credentials.email||!t.credentials.password){t.formError="Todo los campos son requeridos";return false}else{t.doRegister()}};t.doRegister=function(){t.formError="";n.register(t.credentials).error(function(e){t.formError=e}).then(function(){e.search("page",null);e.path(t.returnPage)})}}})();(function(){angular.module("loc8rApp").controller("locationDetailCtrl",e);e.$inject=["$routeParams","$location","$modal","loc8rData","authentication"];function e(e,n,t,o,r){var i=this;i.locationid=e.locationid;i.isLoggedIn=r.isLoggedIn();i.currentPath=n.path();o.locationById(i.locationid).success(function(e){i.data={location:e};i.pageHeader={title:i.data.location.name}}).error(function(e){console.log(e)});i.popupReviewForm=function(){var e=t.open({templateUrl:"/reviewModal/reviewModal.view.html",controller:"reviewModalCtrl as vm",resolve:{locationData:function(){return{locationid:i.locationid,locationName:i.data.location.name}}}});e.result.then(function(e){i.data.location.reviews.push(e)})}}})();(function(){angular.module("loc8rApp").controller("reviewModalCtrl",e);e.$inject=["$modalInstance","loc8rData","locationData"];function e(e,n,t){var o=this;o.locationData=t;o.onSubmit=function(){o.formError="";if(!o.formData.rating||!o.formData.reviewText){o.formError="All fields required, please try again";return false}else{o.doAddReview(o.locationData.locationid,o.formData)}};o.doAddReview=function(e,t){n.addReviewById(e,{rating:t.rating,reviewText:t.reviewText}).success(function(e){o.modal.close(e)}).error(function(e){o.formError="Your review has not been saved, try again"});return false};o.modal={close:function(n){e.close(n)},cancel:function(){e.dismiss("cancel")}}}})();(function(){angular.module("loc8rApp").service("authentication",e);e.$inject=["$http","$window"];function e(e,n){var t=function(e){n.localStorage["loc8r-token"]=e};var o=function(){return n.localStorage["loc8r-token"]};var r=function(){var e=o();if(e){var t=JSON.parse(n.atob(e.split(".")[1]));return t.exp>Date.now()/1e3}else{return false}};var i=function(){if(r()){var e=o();var t=JSON.parse(n.atob(e.split(".")[1]));return{email:t.email,name:t.name,username:t.username}}};register=function(n){return e.post("/api/register",n).success(function(e){t(e.token)})};login=function(n){return e.post("/api/login",n).success(function(e){t(e.token)})};logout=function(){n.localStorage.removeItem("loc8r-token")};return{currentUser:i,saveToken:t,getToken:o,isLoggedIn:r,register:register,login:login,logout:logout}}})();(function(){angular.module("loc8rApp").service("geolocation",e);function e(){var e=function(e,n,t){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(e,n)}else{t()}};return{getPosition:e}}})();(function(){angular.module("loc8rApp").service("loc8rData",e);e.$inject=["$http","authentication"];function e(e,n){var t=function(n,t){return e.get("/api/locations?lng="+t+"&lat="+n+"&maxDistance=1000000000")};var o=function(n){return e.get("/api/locations/"+n)};var r=function(t,o){return e.post("/api/locations/"+t+"/reviews",o,{headers:{Authorization:"Bearer "+n.getToken()}})};return{locationByCoords:t,locationById:o,addReviewById:r}}})();(function(){angular.module("loc8rApp").filter("formatDistance",n);var e=function(e){return!isNaN(parseFloat(e))&&isFinite(e)};function n(){return function(n){var t,o;if(n&&e(n)){if(n>1){t=parseFloat(n).toFixed(1);o=" km"}else{t=parseInt(n*1e3,10);o=" m"}return t+o}else{return"?"}}}})();(function(){angular.module("loc8rApp").filter("addHtmlLineBreaks",e);function e(){return function(e){var n=e.replace(/\n/g,"<br/>");return n}}})();(function(){angular.module("loc8rApp").controller("navigationCtrl",e);e.$inject=["$location","authentication"];function e(e,n){var t=this;t.currentPath=e.path();t.isLoggedIn=n.isLoggedIn();t.currentUser=n.currentUser();t.logout=function(){n.logout();e.path("/")}}})();(function(){angular.module("loc8rApp").directive("ratingStars",e);function e(){return{restrict:"EA",scope:{thisRating:"=rating"},templateUrl:"/common/directives/ratingStars/ratingStars.template.html"}}})();(function(){angular.module("loc8rApp").directive("footerGeneric",e);function e(){return{restrict:"EA",templateUrl:"/common/directives/footerGeneric/footerGeneric.template.html"}}})();(function(){angular.module("loc8rApp").directive("navigation",e);function e(){return{restrict:"EA",templateUrl:"/common/directives/navigation/navigation.template.html",controller:"navigationCtrl as navvm"}}})();(function(){angular.module("loc8rApp").directive("pageHeader",e);function e(){return{restrict:"EA",scope:{content:"=content"},templateUrl:"/common/directives/pageHeader/pageHeader.template.html"}}})();